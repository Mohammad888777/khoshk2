{% extends 'main/base.html' %}


{% load static %}
{% load humanize %}


{% block title %}
{% endblock title %}



{% block head %}

<script src="{% static 'jquery-3.7.1.min.js' %}" ></script>



<script src=" https://cdn.jsdelivr.net/npm/jquery-toast-plugin@1.3.2/dist/jquery.toast.min.js "></script>
<link href=" https://cdn.jsdelivr.net/npm/jquery-toast-plugin@1.3.2/dist/jquery.toast.min.css " rel="stylesheet">




<link rel="stylesheet" href="{% static 'css/jquery.toast.css' %}">

<style>
        input[type='text']{
            text-align:right;
        }

        input[type='email']{
            text-align:right;
        }

        textarea[name="address"]{
            text-align:right;

        }
    </style>
{% endblock head %}





        <!-- <div class="evand-widget evand-widget-event-registration" data-event-slug="انبارگردانی-داروخانه-106865"
        data-setting=""><script>(function(){if(!document.getElementById('evand-widget-event-registration'))
        {var t=document.createElement("script");t.type="text/javascript";
        t.async=!0;t.src=("https:"==document.location.protocol?"https://":"http://")+"widgets.evand.com/event-registration.js?load=1";
        t.setAttribute('id','evand-widget-event-registration');
        var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e);}})();</script></div> -->

{% block content %}


        {% if request.user.is_authenticated %}

        <p style="display: none;" id="{{order.id}}" class="fororderId" ></p>

   
                <div class="search-area">
                        <div class="container">
                                <div class="row">
                                        <div class="col-lg-12">
                                                <span class="close-btn"><i class="fas fa-window-close"></i></span>
                                                <div class="search-bar">
                                                        <div class="search-bar-tablecell">
                                                                <h3>Search For:</h3>
                                                                <input type="text" placeholder="Keywords">
                                                                <button type="submit">Search <i class="fas fa-search"></i></button>
                                                        </div>
                                                </div>
                                        </div>
                                </div>
                        </div>
                </div>

                
                <div class="breadcrumb-section breadcrumb-bg">
                        <div class="container">
                                <div class="row">
                                        <div class="col-lg-8 offset-lg-2 text-center">
                                                <div class="breadcrumb-text">
                                                        <!-- <p>Fresh and Organic</p> -->
                                                        <h1>پرداخت</h1>
                                                </div>
                                        </div>
                                </div>
                        </div>
                </div>

                
                <div class="checkout-section mt-150 mb-150">
                        <div class="container">
                                <div class="row">

                                        

                                        <div class="col-lg-8">
                                                <div class="checkout-accordion-wrap">
                                                        <div class="accordion" id="accordionExample">
                                                        <div class="card single-accordion">
                                                        <div class="card-header" id="headingOne">
                                                        <h5 class="mb-0 ">
                                                                <button class="btn btn-link text-right" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                                                آدرس
                                                                </button>
                                                        </h5>
                                                        </div>

                                                        <div id="collapseOne" class="collapse show" aria-labelledby="headingOne" data-parent="#accordionExample">
                                                        <div class="card-body">
                                                                <div class="billing-address-form">
                                                                        <form action="index.html" >
                                                                                <p><input type="text" name="name"  placeholder="نام"></p>
                                                                                <!-- <p><input type="email" placeholder="Email"></p> -->
                                                                                <p><input type="text" name="city"  placeholder="شهر" ></p>
                                                                                <p><textarea  name="address" id="bill" cols="30" rows="10" 
                                                                                placeholder="آدرس "></textarea>
                                                                        </p>
                                                                        </form>
                                                                </div>
                                                        </div>
                                                        </div>
                                                        </div>
                                                        
                                                        
                                        
                                                        </div>

                                                </div>
                                        </div>

                                        <div class="col-lg-4">
                                                <div class="order-details-wrap">
                                                        <table class="order-details">
                                                                <thead>
                                                                        <tr>
                                                                                <th>هزینه ها</th>
                                                                                <th>جزییات سفارش شما</th>
                                                                        </tr>
                                                                </thead>
                                                                <tbody class="order-details-body text-right">
                                                                        <tr>
                                                                                <td>مجموع</td>
                                                                                <td>محصولات</td>
                                                                        </tr>
                                                                        {% for i in order.items.all %}
                                                                                <tr>
                                                                                        <td>تومان{{i.each_category_price|floatformat:"u"|intcomma:False}}</td>
                                                                                        <td>{{i.product.name}}</td>
                                                                                </tr>
                                                                        {% endfor %}
                                                         
                                                                </tbody>
                                                                <tbody class="checkout-details">

                                                                        <tr>
                                                                                <td>تومان{{order.amount|floatformat:"u"|intcomma:False}}</td>
                                                                                <td>هزینه سفارش</td>
                                                                        </tr>
                                                                        <tr>
                                                                                <td>0</td>
                                                                                <td>هزینه ارسال</td>
                                                                        </tr>
                                                                        <tr>
                                                                                <td>تومان{{order.final_amount|floatformat:"u"|intcomma:False}}</td>
                                                                                <td>هزینه نهایی</td>
                                                                        </tr>
                                                                </tbody>
                                                        </table>
                                                        <a id="payOrder" class="boxed-btn text-right">پرداخت</a>
                                                </div>
                                        </div>
                                </div>
                        </div>

                        {% if not order.used_copon %}
                                <div class="container">
                                        <div class="container">
                                                <div class="container">
                                                        <div class="container">
                                                                <div class="coupon-section">

                                                                        <h3 class="text-right">کدتخفیف</h3>
                                                                        <div class="coupon-form-wrap">
                                        
                                                                                <form method="post" id="coponForm"  >
                                                                                        {% csrf_token %}
                                                                                        <p><input type="text" placeholder="کدتخفیف" name="copon"></p>
                                                                                        <p class="text-right"><input type="submit" value="اعمال کد"></p>
                                                                                </form>
                                        
                                                                        </div>
                                        
                                                                </div>
                                                        </div>
                                                </div>
                                        </div>
                                </div>
                        {% endif %}
                        
                </div>
                

                <script type="text/javascript" >

                        $(document).ready(function(){

                                
                                $("#coponForm").submit(function(e){

                                        e.preventDefault();

                                        let url="/order/addcopon/";
                                        let order_id=$(".fororderId").attr("id")

                                        let form=new FormData(this);

                                        form.append("order",order_id)

                                        let copon_val=$("input[type=text][name=copon]")

                                        if (!copon_val.val()){

                                                $.toast({ 
                                                        text : "<p style='font-size:18px' class='text-center'>لطفا مقدار را وارد نمایید</p>", 
                                                        showHideTransition : 'slide',  // It can be plain, fade or slide
                                                        bgColor : '#ff3647',              // Background color for toast
                                                        textColor : '#000',            // text color
                                                        allowToastClose : false,       // Show the close button or not
                                                        hideAfter : 5000,              // `false` to make it sticky or time in miliseconds to hide after
                                                        stack : 5,                     // `fakse` to show one stack at a time count showing the number of toasts that can be shown at once
                                                        textAlign : 'right',            // Alignment of text i.e. left, right, center
                                                        position : 'bottom-center'       // bottom-left or bottom-right or bottom-center or top-left or top-right or top-center or mid-center or an object representing the left, right, top, bottom values to position the toast on page
                                                });
                                                
                                        
                                        }


                                        if(copon_val.val()){
                                        

                                                try{
                                                        
                                                        $.ajax({

                                                        contentType: false,
                                                        cache: false,
                                                        processData:false,
                                                        url,
                                                        method:"POST",
                                                        data:form,

                                                        success:function(e){

                                                                if(e.error){


                                                                        if(e.loggin_required){

                                                                                $.toast({ 
                                                                                        text : "<p style='font-size:18px' class='text-center'>لطفا ابتدا وارد شوید</p>", 
                                                                                        showHideTransition : 'slide',  // It can be plain, fade or slide
                                                                                        bgColor : '#ff3647',              // Background color for toast
                                                                                        textColor : '#000',            // text color
                                                                                        allowToastClose : false,       // Show the close button or not
                                                                                        hideAfter : 5000,              // `false` to make it sticky or time in miliseconds to hide after
                                                                                        stack : 5,                     // `fakse` to show one stack at a time count showing the number of toasts that can be shown at once
                                                                                        textAlign : 'right',            // Alignment of text i.e. left, right, center
                                                                                        position : 'bottom-center'       // bottom-left or bottom-right or bottom-center or top-left or top-right or top-center or mid-center or an object representing the left, right, top, bottom values to position the toast on page
                                                                                });

                                                                        }

                                                                        if(e.many){

                                                                                $.toast({ 
                                                                                        text : "<p style='font-size:18px' class='text-center'>دسترسی شما برای مدت محدود شده است لطفا بعدا امتحان کنید</p>", 
                                                                                        showHideTransition : 'slide',  // It can be plain, fade or slide
                                                                                        bgColor : '#ff3647',              // Background color for toast
                                                                                        textColor : '#000',            // text color
                                                                                        allowToastClose : false,       // Show the close button or not
                                                                                        hideAfter : 5000,              // `false` to make it sticky or time in miliseconds to hide after
                                                                                        stack : 5,                     // `fakse` to show one stack at a time count showing the number of toasts that can be shown at once
                                                                                        textAlign : 'right',            // Alignment of text i.e. left, right, center
                                                                                        position : 'bottom-center'       // bottom-left or bottom-right or bottom-center or top-left or top-right or top-center or mid-center or an object representing the left, right, top, bottom values to position the toast on page
                                                                                });
                                                                                


                                                                                function reddirect_func(){
                                                                                window.location.href="/"
                                                                                }

                                                                                const re=setTimeout(reddirect_func,5000)

                                                                        }
                                                                        
                                                                        if(e.copon){

                                                                                $.toast({ 
                                                                                        text : "<p style='font-size:18px' class='text-center'>مقدار کوپون را وارد نمایید</p>", 
                                                                                        showHideTransition : 'slide',  // It can be plain, fade or slide
                                                                                        bgColor : '#ff3647',              // Background color for toast
                                                                                        textColor : '#000',            // text color
                                                                                        allowToastClose : false,       // Show the close button or not
                                                                                        hideAfter : 5000,              // `false` to make it sticky or time in miliseconds to hide after
                                                                                        stack : 5,                     // `fakse` to show one stack at a time count showing the number of toasts that can be shown at once
                                                                                        textAlign : 'right',            // Alignment of text i.e. left, right, center
                                                                                        position : 'bottom-center'       // bottom-left or bottom-right or bottom-center or top-left or top-right or top-center or mid-center or an object representing the left, right, top, bottom values to position the toast on page
                                                                                });
                                                                                copon_val.val('')


                                                                        }
                                                                        

                                                                        if(e.order){

                                                                                $.toast({ 

                                                                                        text : "<p style='font-size:18px' class='text-center'>مشکلی وجوددارد دوباه امتحان کنید</p>", 
                                                                                        showHideTransition : 'slide',  // It can be plain, fade or slide
                                                                                        bgColor : '#ff3647',              // Background color for toast
                                                                                        textColor : '#000',            // text color
                                                                                        allowToastClose : false,       // Show the close button or not
                                                                                        hideAfter : 5000,              // `false` to make it sticky or time in miliseconds to hide after
                                                                                        stack : 5,                     // `fakse` to show one stack at a time count showing the number of toasts that can be shown at once
                                                                                        textAlign : 'right',            // Alignment of text i.e. left, right, center
                                                                                        position : 'bottom-center'       // bottom-left or bottom-right or bottom-center or top-left or top-right or top-center or mid-center or an object representing the left, right, top, bottom values to position the toast on page
                                                                                });
                                                                                copon_val.val('')
                                                                                

                                                                        }

                                                                        if(e.copon_ex){

                                                                                $.toast({ 

                                                                                text : "<p style='font-size:18px' class='text-center'>کدتخفیف معتبر نمیباشد</p>", 
                                                                                showHideTransition : 'slide',  // It can be plain, fade or slide
                                                                                bgColor : '#ff3647',              // Background color for toast
                                                                                textColor : '#000',            // text color
                                                                                allowToastClose : false,       // Show the close button or not
                                                                                hideAfter : 5000,              // `false` to make it sticky or time in miliseconds to hide after
                                                                                stack : 5,                     // `fakse` to show one stack at a time count showing the number of toasts that can be shown at once
                                                                                textAlign : 'right',            // Alignment of text i.e. left, right, center
                                                                                position : 'bottom-center'       // bottom-left or bottom-right or bottom-center or top-left or top-right or top-center or mid-center or an object representing the left, right, top, bottom values to position the toast on page
                                                                                });
                                                                                copon_val.val('')

                                                                        }


                                                                        if(e.order_ex){

                                                                                $.toast({ 

                                                                                text : "<p style='font-size:18px' class='text-center'>سفارش شما ثبت نشده است دوباره تلاش کنید</p>", 
                                                                                showHideTransition : 'slide',  // It can be plain, fade or slide
                                                                                bgColor : '#ff3647',              // Background color for toast
                                                                                textColor : '#000',            // text color
                                                                                allowToastClose : false,       // Show the close button or not
                                                                                hideAfter : 5000,              // `false` to make it sticky or time in miliseconds to hide after
                                                                                stack : 5,                     // `fakse` to show one stack at a time count showing the number of toasts that can be shown at once
                                                                                textAlign : 'right',            // Alignment of text i.e. left, right, center
                                                                                position : 'bottom-center'       // bottom-left or bottom-right or bottom-center or top-left or top-right or top-center or mid-center or an object representing the left, right, top, bottom values to position the toast on page
                                                                                });

                                                                                copon_val.val('')

                                                                                function reddirect_func(){
                                                                                window.location.href="/"
                                                                                }

                                                                                const re=setTimeout(reddirect_func,5000)
                                                                        }

                                                                        if(e.pay){

                                                                                $.toast({ 
                                                                                        text : "<p style='font-size:18px' class='text-center'>مشکلی وجود دارد بعدا امتحان کنید</p>", 
                                                                                        showHideTransition : 'slide',  // It can be plain, fade or slide
                                                                                        bgColor : '#ff3647',              // Background color for toast
                                                                                        textColor : '#000',            // text color
                                                                                        allowToastClose : false,       // Show the close button or not
                                                                                        hideAfter : 5000,              // `false` to make it sticky or time in miliseconds to hide after
                                                                                        stack : 5,                     // `fakse` to show one stack at a time count showing the number of toasts that can be shown at once
                                                                                        textAlign : 'right',            // Alignment of text i.e. left, right, center
                                                                                        position : 'bottom-center'       // bottom-left or bottom-right or bottom-center or top-left or top-right or top-center or mid-center or an object representing the left, right, top, bottom values to position the toast on page
                                                                                });
                                                                        }

                                                                        
                                                                }


                                                                if(e.new_amount){

                                                                        $.toast({ 

                                                                                text : "<p style='font-size:18px' class='text-center'>کدتخفیف شما اعمال شد</p>", 
                                                                                showHideTransition : 'slide',  // It can be plain, fade or slide
                                                                                bgColor : '#20c429',              // Background color for toast
                                                                                textColor : '#000',            // text color
                                                                                allowToastClose : false,       // Show the close button or not
                                                                                hideAfter : 5000,              // `false` to make it sticky or time in miliseconds to hide after
                                                                                stack : 5,                     // `fakse` to show one stack at a time count showing the number of toasts that can be shown at once
                                                                                textAlign : 'right',            // Alignment of text i.e. left, right, center
                                                                                position : 'bottom-center'       // bottom-left or bottom-right or bottom-center or top-left or top-right or top-center or mid-center or an object representing the left, right, top, bottom values to position the toast on page
                                                                        });

                                                                        copon_val.val('')

                                                                        function reddirect_func(){
                                                                                window.location.reload();
                                                                        }

                                                                        const re=setTimeout(reddirect_func,3000)

                                                                }


                                                                console.log(e)

                                                        },

                                                        error:function(e){
                                                                console.log(e)
                                                        },



                                                        })


                                                }

                                                catch(e){
                                                        console.log(e)
                                                        
                                                        $.toast({ 
                                                                text : "<p style='font-size:18px' class='text-center'>مشکلی وجودداردلطفا بعدا امتحان کنید</p>", 
                                                                showHideTransition : 'slide',  // It can be plain, fade or slide
                                                                bgColor : '#ff3647',              // Background color for toast
                                                                textColor : '#000',            // text color
                                                                allowToastClose : false,       // Show the close button or not
                                                                hideAfter : 5000,              // `false` to make it sticky or time in miliseconds to hide after
                                                                stack : 5,                     // `fakse` to show one stack at a time count showing the number of toasts that can be shown at once
                                                                textAlign : 'right',            // Alignment of text i.e. left, right, center
                                                                position : 'bottom-center'       // bottom-left or bottom-right or bottom-center or top-left or top-right or top-center or mid-center or an object representing the left, right, top, bottom values to position the toast on page
                                                        });
                                                
                                                }

                                        }


                                })
                                

                                $("#payOrder").click(function(e){

                                        let order_id=$(".fororderId").attr("id")

                                        function getCookie(name) {

                                                let cookieValue = null;
                                                if (document.cookie && document.cookie !== '') {
                                                const cookies = document.cookie.split(';');
                                                for (let i = 0; i < cookies.length; i++) {
                                                        const cookie = cookies[i].trim();
                                                        // Does this cookie string begin with the name we want?
                                                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                                        break;
                                                        }
                                                }
                                                }
                                                return cookieValue;

                                        }

                                        const csrftoken = getCookie('csrftoken');

                                        let name_input=$("input[type=text][name=name]");
                                        let city=$("input[type=text][name=city]");
                                        let address=$("#bill[name=address]");


                                        console.log(name_input.val())
                                        console.log(city.val())

                                        let url=`/order/paymentView/${order_id}/`;

                                        if(!name_input.val()){

                                                $.toast({ 
                                                        text : "<p style='font-size:18px' class='text-center'>لطفا نام خودرا وارد نمایید</p>", 
                                                        showHideTransition : 'slide',  // It can be plain, fade or slide
                                                        bgColor : '#ff3647',              // Background color for toast
                                                        textColor : '#000',            // text color
                                                        allowToastClose : false,       // Show the close button or not
                                                        hideAfter : 5000,              // `false` to make it sticky or time in miliseconds to hide after
                                                        stack : 5,                     // `fakse` to show one stack at a time count showing the number of toasts that can be shown at once
                                                        textAlign : 'right',            // Alignment of text i.e. left, right, center
                                                        position : 'bottom-center'       // bottom-left or bottom-right or bottom-center or top-left or top-right or top-center or mid-center or an object representing the left, right, top, bottom values to position the toast on page
                                                });
                                                
                                        }

                                        if(!city.val()){

                                                $.toast({ 
                                                        text : "<p style='font-size:18px' class='text-center'>لطفا شهر خودرا وارد نمایید</p>", 
                                                        showHideTransition : 'slide',  // It can be plain, fade or slide
                                                        bgColor : '#ff3647',              // Background color for toast
                                                        textColor : '#000',            // text color
                                                        allowToastClose : false,       // Show the close button or not
                                                        hideAfter : 5000,              // `false` to make it sticky or time in miliseconds to hide after
                                                        stack : 5,                     // `fakse` to show one stack at a time count showing the number of toasts that can be shown at once
                                                        textAlign : 'right',            // Alignment of text i.e. left, right, center
                                                        position : 'bottom-center'       // bottom-left or bottom-right or bottom-center or top-left or top-right or top-center or mid-center or an object representing the left, right, top, bottom values to position the toast on page
                                                });
                                        }



                                        if(!address.val()){

                                                $.toast({ 
                                                        text : "<p style='font-size:18px' class='text-center'>لطفا آدرس خودرا وارد نمایید</p>", 
                                                        showHideTransition : 'slide',  // It can be plain, fade or slide
                                                        bgColor : '#ff3647',              // Background color for toast
                                                        textColor : '#000',            // text color
                                                        allowToastClose : false,       // Show the close button or not
                                                        hideAfter : 5000,              // `false` to make it sticky or time in miliseconds to hide after
                                                        stack : 5,                     // `fakse` to show one stack at a time count showing the number of toasts that can be shown at once
                                                        textAlign : 'right',            // Alignment of text i.e. left, right, center
                                                        position : 'bottom-center'       // bottom-left or bottom-right or bottom-center or top-left or top-right or top-center or mid-center or an object representing the left, right, top, bottom values to position the toast on page
                                                });
                                        }


                                        if(
                                                name_input.val() &&
                                                city.val() &&
                                                address.val()
                                        )

                                        {

                                                try{

                                                        $.ajax({

                                                                url,
                                                                method:"GET",
                                                                data:{
                                                                        'csrfmiddlewaretoken':csrftoken,
                                                                        
                                                                        "city":city.val(),
                                                                        "address":address.val(),
                                                                        "name":name_input.val()
                                                                },

                                                                success:function(e){

                                                                        console.log(e)

                                                                        if(e.error){

                                                                                if(e.loggin_required){

                                                                                        $.toast({ 
                                                                                                text : "<p style='font-size:18px' class='text-center'>لطفا ابتدا وارد شوید</p>", 
                                                                                                showHideTransition : 'slide',  // It can be plain, fade or slide
                                                                                                bgColor : '#ff3647',              // Background color for toast
                                                                                                textColor : '#000',            // text color
                                                                                                allowToastClose : false,       // Show the close button or not
                                                                                                hideAfter : 5000,              // `false` to make it sticky or time in miliseconds to hide after
                                                                                                stack : 5,                     // `fakse` to show one stack at a time count showing the number of toasts that can be shown at once
                                                                                                textAlign : 'right',            // Alignment of text i.e. left, right, center
                                                                                                position : 'bottom-center'       // bottom-left or bottom-right or bottom-center or top-left or top-right or top-center or mid-center or an object representing the left, right, top, bottom values to position the toast on page
                                                                                        });

                                                                                }  

                                                                        }


                                                                        if(e.link){
                                                                                window.location.href=e.link
                                                                        }

                                                                },

                                                                error:function(e){
                                                                        console.log(e,"EERRRR")
                                                                }
                                                        })

                                                }

                                                catch(e){


                                                }

                                        }







                                })



                        })

                </script>


        {% endif %}

{% endblock content %}




{% block script %}

<script src="{% static 'js/jquery.toast.js' %}" ></script>
{% endblock script %}
